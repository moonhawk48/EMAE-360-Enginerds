                                                                          
  %%%%%%%%%%%%%%    %%%%%%%%%%%      %%%     %%%      %%%%%%%%%%%         
       %%%          %%%              %%%%   %%%%      %%%                 
       %%%          %%%              %%% % % %%%      %%%                 
       %%%          %%%              %%%  %  %%%      %%%%%%%%%%%         
       %%%          %%%              %%%     %%%              %%%         
       %%%          %%%              %%%     %%%              %%%         
       %%%rue       %%%%%%%%%%%ycle  %%%     %%%otor  %%%%%%%%%%%imulator 
                                                                    
       % Mirko Casale, Marco Marzocchi, Dario Santoro, Simone Talento %
       
       % Conversione in Matlab di cicli0D (VB) del prof. Fabio Bozza %
       
                                     %2019%

% Libreria
   
classdef OdLibv2
 methods (Static)
     
   function [A, B] =  Vasp (a, b,anta) %Valuta il tempo (in angoli di manovella) e la sezione (in m^2)legati alla legge di alzata della valvola di aspirazione
     %legge di alzata  
Lalz = [0 0 0 
0.0049016 0.000288039 0.000305325 
0.0098032 0.00142099 0.00150633 
0.0147048 0.00262596 0.00278376 
0.0196064 0.00390054 0.00413511 
0.024508 0.00555317 0.00588744 
0.0294096 0.00733301 0.00777487 
0.0343112 0.00966973 0.0102532 
0.0392128 0.0122369 0.0129763 
0.0441144 0.0154233 0.016357 
0.049016 0.0191306 0.0202912 
0.0539176 0.0233084 0.0247258 
0.0588192 0.0283695 0.0300997 
0.0637208 0.0337186 0.0357813 
0.0686224 0.0401623 0.0426281 
0.073524 0.0470141 0.0499117 
0.0784256 0.054874 0.058271 
0.0833272 0.0633867 0.0673295 
0.0882288 0.0724504 0.0769797 
0.0931304 0.0826422 0.0878378 
0.098032 0.0931868 0.0990795 
0.102934 0.104941 0.11162 
0.107835 0.117106 0.124609 
0.112737 0.134333 0.138693 
0.117638 0.153917 0.153485 
0.12254 0.17417 0.168823 
0.127442 0.195659 0.185143 
0.132343 0.217514 0.201789 
0.137245 0.240502 0.219349 
0.142146 0.263816 0.237215 
0.147048 0.287816 0.255663 
0.15195 0.310273 0.274564 
0.156851 0.332459 0.293792 
0.161753 0.354948 0.31336 
0.166654 0.377505 0.333066 
0.171556 0.400147 0.352923 
0.176458 0.422757 0.372832 
0.181359 0.445307 0.392767 
0.186261 0.471383 0.412883 
0.191162 0.497826 0.432974 
0.196064 0.523714 0.452756 
0.200966 0.549423 0.472511 
0.205867 0.574446 0.491843 
0.210769 0.599274 0.511127 
0.21567 0.62375 0.530237 
0.220572 0.645008 0.547179 
0.225474 0.663764 0.562287 
0.230375 0.682 0.576854 
0.235277 0.700093 0.591188 
0.240178 0.717731 0.605048 
0.24508 0.735144 0.618622 
0.249982 0.75218 0.631796 
0.254883 0.768892 0.644618 
0.259785 0.784842 0.656973 
0.264686 0.798776 0.668258 
0.269588 0.812586 0.679316 
0.27449 0.825945 0.689891 
0.279391 0.839129 0.700213 
0.284293 0.85204 0.710209 
0.289194 0.864615 0.719837 
0.294096 0.877003 0.729221 
0.298998 0.88899 0.738203 
0.303899 0.90085 0.746996 
0.308801 0.910597 0.754001 
0.313702 0.916669 0.757843 
0.318604 0.922573 0.761379 
0.323506 0.928316 0.764633 
0.328407 0.933978 0.767659 
0.333309 0.93938 0.770379 
0.33821 0.944717 0.772906 
0.343112 0.949853 0.775186 
0.348014 0.954868 0.777271 
0.352915 0.959721 0.779154 
0.357817 0.964382 0.780838 
0.362718 0.968951 0.782371 
0.36762 0.973257 0.783709 
0.372522 0.977498 0.784925 
0.377423 0.979185 0.785083 
0.382325 0.980819 0.785135 
0.387226 0.982388 0.785091 
0.392128 0.983862 0.784965 
0.39703 0.985295 0.784764 
0.401931 0.986649 0.784504 
0.406833 0.987971 0.784183 
0.411734 0.989185 0.783831 
0.416636 0.990345 0.783443 
0.421538 0.991441 0.78303 
0.426439 0.992465 0.782603 
0.431341 0.99346 0.782151 
0.436242 0.994341 0.78172 
0.441144 0.995192 0.781275 
0.446046 0.995951 0.780856 
0.450947 0.996653 0.780449 
0.455849 0.997294 0.780061 
0.46075 0.997849 0.779713 
0.465652 0.998372 0.779374 
0.470554 0.998779 0.779104 
0.475455 0.999155 0.778848 
0.480357 0.999442 0.778649 
0.485258 0.999679 0.778483 
0.49016 0.999864 0.778351 
0.495062 0.999949 0.77829 
0.499963 1. 0.778254 
0.504865 0.999949 0.77829 
0.509766 0.999864 0.778351 
0.514668 0.999679 0.778483 
0.51957 0.999442 0.778649 
0.524471 0.999155 0.778848 
0.529373 0.998779 0.779104 
0.534274 0.998372 0.779374 
0.539176 0.997849 0.779713 
0.544078 0.997294 0.780061 
0.548979 0.996653 0.780449 
0.553881 0.995951 0.780856 
0.558782 0.995192 0.781275 
0.563684 0.994341 0.78172 
0.568586 0.99346 0.782151 
0.573487 0.992465 0.782603 
0.578389 0.991441 0.78303 
0.58329 0.990345 0.783443 
0.588192 0.989185 0.783831 
0.593094 0.987971 0.784183 
0.597995 0.986649 0.784504 
0.602897 0.985295 0.784764 
0.607798 0.983862 0.784965 
0.6127 0.982388 0.785091 
0.617602 0.980819 0.785135 
0.622503 0.979185 0.785083 
0.627405 0.977498 0.784925 
0.632306 0.973257 0.783709 
0.637208 0.968951 0.782371 
0.64211 0.964382 0.780838 
0.647011 0.959721 0.779154 
0.651913 0.954868 0.777271 
0.656814 0.949853 0.775186 
0.661716 0.944717 0.772906 
0.666618 0.93938 0.770379 
0.671519 0.933978 0.767659 
0.676421 0.928316 0.764633 
0.681322 0.922573 0.76138 
0.686224 0.916669 0.757843 
0.691126 0.910597 0.754001 
0.696027 0.90085 0.746996 
0.700929 0.888989 0.738202 
0.70583 0.877003 0.729221 
0.710732 0.864615 0.719837 
0.715634 0.85204 0.710209 
0.720535 0.839129 0.700213 
0.725437 0.825945 0.689892 
0.730338 0.812586 0.679316 
0.73524 0.798776 0.668258 
0.740142 0.784842 0.656973 
0.745043 0.768892 0.644618 
0.749945 0.75218 0.631796 
0.754846 0.735144 0.618622 
0.759748 0.717731 0.605048 
0.76465 0.700093 0.591188 
0.769551 0.682 0.576854 
0.774453 0.663764 0.562287 
0.779354 0.645008 0.547179 
0.784256 0.623751 0.530238 
0.789158 0.599274 0.511127 
0.794059 0.574446 0.491843 
0.798961 0.549423 0.472511 
0.803862 0.523714 0.452756 
0.808764 0.497826 0.432975 
0.813666 0.471383 0.412883 
0.818567 0.445307 0.392767 
0.823469 0.422756 0.372832 
0.82837 0.400147 0.352923 
0.833272 0.377506 0.333066 
0.838174 0.354948 0.31336 
0.843075 0.332459 0.293792 
0.847977 0.310273 0.274564 
0.852878 0.287816 0.255663 
0.85778 0.263816 0.237215 
0.862682 0.240502 0.219349 
0.867583 0.217514 0.201789 
0.872485 0.195659 0.185143 
0.877386 0.17417 0.168823 
0.882288 0.153917 0.153485 
0.88719 0.134333 0.138693 
0.892091 0.117106 0.124608 
0.896993 0.104941 0.11162 
0.901895 0.0931869 0.0990795 
0.906796 0.0826422 0.0878378 
0.911698 0.0724504 0.0769797 
0.916599 0.0633867 0.0673294 
0.921501 0.054874 0.058271 
0.926403 0.0470141 0.0499117 
0.931304 0.0401623 0.0426281 
0.936206 0.0337186 0.0357813 
0.941107 0.0283695 0.0300996 
0.946009 0.0233084 0.0247258 
0.950911 0.0191306 0.0202912 
0.955812 0.0154233 0.016357 
0.960714 0.0122369 0.0129763 
0.965615 0.00966972 0.0102532 
0.970517 0.00733303 0.00777489 
0.975418 0.00555317 0.00588744 
0.98032 0.00390054 0.00413511 
0.985222 0.00262596 0.00278376 
0.990123 0.00142099 0.00150632 
0.995025 0.000288045 0.000305331 
1 0 0 
];


for i= 1:size(Lalz,1)
A(i) = 360 - anta + Lalz(i,1) * a ;         %Angolo a cui corrisponde la sezione di aspirazione all'i-esimo teta
B(i) = Lalz(i,2) * b ;                      %Sezione di passaggio
end
   end
   
   
   function [C, D] =  Vsca (c, d,ants) %Valuta il tempo (in angoli di manovella) e la sezione (in m^2)legati alla legge di alzata della valvola di scarico
                                          
    %legge di alzata
Lalz = [0 0 0 
0.0049016 0.000288039 0.000305325 
0.0098032 0.00142099 0.00150633 
0.0147048 0.00262596 0.00278376 
0.0196064 0.00390054 0.00413511 
0.024508 0.00555317 0.00588744 
0.0294096 0.00733301 0.00777487 
0.0343112 0.00966973 0.0102532 
0.0392128 0.0122369 0.0129763 
0.0441144 0.0154233 0.016357 
0.049016 0.0191306 0.0202912 
0.0539176 0.0233084 0.0247258 
0.0588192 0.0283695 0.0300997 
0.0637208 0.0337186 0.0357813 
0.0686224 0.0401623 0.0426281 
0.073524 0.0470141 0.0499117 
0.0784256 0.054874 0.058271 
0.0833272 0.0633867 0.0673295 
0.0882288 0.0724504 0.0769797 
0.0931304 0.0826422 0.0878378 
0.098032 0.0931868 0.0990795 
0.102934 0.104941 0.11162 
0.107835 0.117106 0.124609 
0.112737 0.134333 0.138693 
0.117638 0.153917 0.153485 
0.12254 0.17417 0.168823 
0.127442 0.195659 0.185143 
0.132343 0.217514 0.201789 
0.137245 0.240502 0.219349 
0.142146 0.263816 0.237215 
0.147048 0.287816 0.255663 
0.15195 0.310273 0.274564 
0.156851 0.332459 0.293792 
0.161753 0.354948 0.31336 
0.166654 0.377505 0.333066 
0.171556 0.400147 0.352923 
0.176458 0.422757 0.372832 
0.181359 0.445307 0.392767 
0.186261 0.471383 0.412883 
0.191162 0.497826 0.432974 
0.196064 0.523714 0.452756 
0.200966 0.549423 0.472511 
0.205867 0.574446 0.491843 
0.210769 0.599274 0.511127 
0.21567 0.62375 0.530237 
0.220572 0.645008 0.547179 
0.225474 0.663764 0.562287 
0.230375 0.682 0.576854 
0.235277 0.700093 0.591188 
0.240178 0.717731 0.605048 
0.24508 0.735144 0.618622 
0.249982 0.75218 0.631796 
0.254883 0.768892 0.644618 
0.259785 0.784842 0.656973 
0.264686 0.798776 0.668258 
0.269588 0.812586 0.679316 
0.27449 0.825945 0.689891 
0.279391 0.839129 0.700213 
0.284293 0.85204 0.710209 
0.289194 0.864615 0.719837 
0.294096 0.877003 0.729221 
0.298998 0.88899 0.738203 
0.303899 0.90085 0.746996 
0.308801 0.910597 0.754001 
0.313702 0.916669 0.757843 
0.318604 0.922573 0.761379 
0.323506 0.928316 0.764633 
0.328407 0.933978 0.767659 
0.333309 0.93938 0.770379 
0.33821 0.944717 0.772906 
0.343112 0.949853 0.775186 
0.348014 0.954868 0.777271 
0.352915 0.959721 0.779154 
0.357817 0.964382 0.780838 
0.362718 0.968951 0.782371 
0.36762 0.973257 0.783709 
0.372522 0.977498 0.784925 
0.377423 0.979185 0.785083 
0.382325 0.980819 0.785135 
0.387226 0.982388 0.785091 
0.392128 0.983862 0.784965 
0.39703 0.985295 0.784764 
0.401931 0.986649 0.784504 
0.406833 0.987971 0.784183 
0.411734 0.989185 0.783831 
0.416636 0.990345 0.783443 
0.421538 0.991441 0.78303 
0.426439 0.992465 0.782603 
0.431341 0.99346 0.782151 
0.436242 0.994341 0.78172 
0.441144 0.995192 0.781275 
0.446046 0.995951 0.780856 
0.450947 0.996653 0.780449 
0.455849 0.997294 0.780061 
0.46075 0.997849 0.779713 
0.465652 0.998372 0.779374 
0.470554 0.998779 0.779104 
0.475455 0.999155 0.778848 
0.480357 0.999442 0.778649 
0.485258 0.999679 0.778483 
0.49016 0.999864 0.778351 
0.495062 0.999949 0.77829 
0.499963 1. 0.778254 
0.504865 0.999949 0.77829 
0.509766 0.999864 0.778351 
0.514668 0.999679 0.778483 
0.51957 0.999442 0.778649 
0.524471 0.999155 0.778848 
0.529373 0.998779 0.779104 
0.534274 0.998372 0.779374 
0.539176 0.997849 0.779713 
0.544078 0.997294 0.780061 
0.548979 0.996653 0.780449 
0.553881 0.995951 0.780856 
0.558782 0.995192 0.781275 
0.563684 0.994341 0.78172 
0.568586 0.99346 0.782151 
0.573487 0.992465 0.782603 
0.578389 0.991441 0.78303 
0.58329 0.990345 0.783443 
0.588192 0.989185 0.783831 
0.593094 0.987971 0.784183 
0.597995 0.986649 0.784504 
0.602897 0.985295 0.784764 
0.607798 0.983862 0.784965 
0.6127 0.982388 0.785091 
0.617602 0.980819 0.785135 
0.622503 0.979185 0.785083 
0.627405 0.977498 0.784925 
0.632306 0.973257 0.783709 
0.637208 0.968951 0.782371 
0.64211 0.964382 0.780838 
0.647011 0.959721 0.779154 
0.651913 0.954868 0.777271 
0.656814 0.949853 0.775186 
0.661716 0.944717 0.772906 
0.666618 0.93938 0.770379 
0.671519 0.933978 0.767659 
0.676421 0.928316 0.764633 
0.681322 0.922573 0.76138 
0.686224 0.916669 0.757843 
0.691126 0.910597 0.754001 
0.696027 0.90085 0.746996 
0.700929 0.888989 0.738202 
0.70583 0.877003 0.729221 
0.710732 0.864615 0.719837 
0.715634 0.85204 0.710209 
0.720535 0.839129 0.700213 
0.725437 0.825945 0.689892 
0.730338 0.812586 0.679316 
0.73524 0.798776 0.668258 
0.740142 0.784842 0.656973 
0.745043 0.768892 0.644618 
0.749945 0.75218 0.631796 
0.754846 0.735144 0.618622 
0.759748 0.717731 0.605048 
0.76465 0.700093 0.591188 
0.769551 0.682 0.576854 
0.774453 0.663764 0.562287 
0.779354 0.645008 0.547179 
0.784256 0.623751 0.530238 
0.789158 0.599274 0.511127 
0.794059 0.574446 0.491843 
0.798961 0.549423 0.472511 
0.803862 0.523714 0.452756 
0.808764 0.497826 0.432975 
0.813666 0.471383 0.412883 
0.818567 0.445307 0.392767 
0.823469 0.422756 0.372832 
0.82837 0.400147 0.352923 
0.833272 0.377506 0.333066 
0.838174 0.354948 0.31336 
0.843075 0.332459 0.293792 
0.847977 0.310273 0.274564 
0.852878 0.287816 0.255663 
0.85778 0.263816 0.237215 
0.862682 0.240502 0.219349 
0.867583 0.217514 0.201789 
0.872485 0.195659 0.185143 
0.877386 0.17417 0.168823 
0.882288 0.153917 0.153485 
0.88719 0.134333 0.138693 
0.892091 0.117106 0.124608 
0.896993 0.104941 0.11162 
0.901895 0.0931869 0.0990795 
0.906796 0.0826422 0.0878378 
0.911698 0.0724504 0.0769797 
0.916599 0.0633867 0.0673294 
0.921501 0.054874 0.058271 
0.926403 0.0470141 0.0499117 
0.931304 0.0401623 0.0426281 
0.936206 0.0337186 0.0357813 
0.941107 0.0283695 0.0300996 
0.946009 0.0233084 0.0247258 
0.950911 0.0191306 0.0202912 
0.955812 0.0154233 0.016357 
0.960714 0.0122369 0.0129763 
0.965615 0.00966972 0.0102532 
0.970517 0.00733303 0.00777489 
0.975418 0.00555317 0.00588744 
0.98032 0.00390054 0.00413511 
0.985222 0.00262596 0.00278376 
0.990123 0.00142099 0.00150632 
0.995025 0.000288045 0.000305331 
1 0 0 
];


for i= 1:size(Lalz,1)
C(i) = 180 - ants + Lalz(i,1) * c ;
D(i) = Lalz(i,2) * d ;
end
   end
   
   
   function [v,dv] = Vdv (fgr,teta,vvc,vvs,rsul) %Legge di variazione del volume del cilindro
       
       

    thr = teta*fgr;             %teta in radianti
    v = vvc + vvs .* 0.5 .* (1 - cos(thr) + rsul .* sin(thr).^2);
    dv = vvs * 0.5 * fgr * (sin(thr) + rsul * sin(2 * thr));
   end
   
   
   function [x] = Merson (neq,teta,dteta,x,fgr,vvc,vvs,rsul,apisto,k,r,pnot,vnot,twall,rpm,thant,dthb,id,alfa,PCIb,cv,cp,pasp,psca,hasp,hsca,roasp,rosca,Taspsca,Aaspsca,ales,up,tnot,aa,e) %Permette l'integrazione delle variabili da calcolare
       
       % K1
       
       D1=teta;
       D=D1;
       [dx1] = OdLibv2.rates (D,x,fgr,vvc,vvs,rsul,apisto,k,r,pnot,vnot,twall,rpm,thant,dthb,id,alfa,PCIb,cv,cp,pasp,psca,hasp,hsca,roasp,rosca,Taspsca,Aaspsca,ales,up,tnot,aa,e);
       
       % K2
       
       D2 = D1+(dteta/3);
       
       for i =  1:neq
           a(i)= x(i)+(dx1(i)*(dteta/3));
       end
       D=D2;
       [dx2] = OdLibv2.rates (D,a,fgr,vvc,vvs,rsul,apisto,k,r,pnot,vnot,twall,rpm,thant,dthb,id,alfa,PCIb,cv,cp,pasp,psca,hasp,hsca,roasp,rosca,Taspsca,Aaspsca,ales,up,tnot,aa,e);
       
       % K3
       
       D3 = D1+(dteta/3);   
       
       for i =  1:neq
           a(i)= x(i)+((dx1(i)+ dx2(i))*(dteta/6));
       end
       D=D3;
       [dx3] = OdLibv2.rates (D,a,fgr,vvc,vvs,rsul,apisto,k,r,pnot,vnot,twall,rpm,thant,dthb,id,alfa,PCIb,cv,cp,pasp,psca,hasp,hsca,roasp,rosca,Taspsca,Aaspsca,ales,up,tnot,aa,e);
       
       % K4
       
       D4 = D1+(dteta/2);
       
       for i =  1:neq
           a(i)= x(i)+((dx1(i)+ 3*dx3(i))*(dteta/8));
       end
       D=D4;
       [dx4] = OdLibv2.rates (D,a,fgr,vvc,vvs,rsul,apisto,k,r,pnot,vnot,twall,rpm,thant,dthb,id,alfa,PCIb,cv,cp,pasp,psca,hasp,hsca,roasp,rosca,Taspsca,Aaspsca,ales,up,tnot,aa,e);
       
       % K5
       
       D5 = D1+dteta;
       
       for i =  1:neq
           a(i)= x(i)+((dx1(i)- 3*dx3(i)+4*dx4(i))*(dteta/2));
       end
       D=D2;
       [dx5] = OdLibv2.rates (D,a,fgr,vvc,vvs,rsul,apisto,k,r,pnot,vnot,twall,rpm,thant,dthb,id,alfa,PCIb,cv,cp,pasp,psca,hasp,hsca,roasp,rosca,Taspsca,Aaspsca,ales,up,tnot,aa,e);
       
       % Aggiorna il vettore dei termini integrati
       
       for i =  1:neq
           x(i)= x(i)+((dx1(i)+ 4*dx4(i)+dx5(i))*(dteta/6));
       end
       
   end
   
   
   function [dx,dxb] = rates (D,x,fgr,vvc,vvs,rsul,apisto,k,r,pnot,vnot,twall,rpm,thant,dthb,id,alfa,PCIb,cv,cp,pasp,psca,hasp,hsca,roasp,rosca,Taspsca,Aaspsca,ales,up,tnot,aa,e) %Risolove le equazioni di bilancio di massa ed energia
       
       teta = D;   %Indicizza l'angolo
       
       [v,dv] = OdLibv2.Vdv (fgr,teta,vvc,vvs,rsul);   %Richiama i valori di v e dv per il teta indicizzato
       
       %Scompone il vettore x dei parametri iniziali
       mb = x(1);
       t = x(2);
       m = x(3);
       
       
       h = cp*t;
       u = cv*t;
       
       %Controllo massa bruciata
       if mb > m
           mb = m;
       end
       
       % Calcolo scambio termico
       
       hspaz = (v - vvc) / apisto;              %Altezza del cilindro sopra il pistone
       aw = pi * ales * hspaz + 2 * apisto;     %Superfici a contatto con i gas
       
       % Calcolo del calore ceduto con le correlazioni di Woschni
       
        cq1 = 2.28;                         %Periodo di compressione                         
        cq2 = 0;
        if mb ~= 0                          %Periodo di combustione                              
            cq2 = 0.00324;
        end
        p = m*r*t/v;
        ro = p / (r * t);
        pm = pnot * (vnot / v) ^ k;
        dlpop = (p - pm) / pnot;
        
        if dlpop < 0 
           dlpop = 0;
        end
        ww = cq1 * up + cq2 * vvs * tnot / vnot * dlpop;
        hh = 3.26 * (ales ^ (-0.2)) * ((p / 1000) ^ (0.8)) * (ww ^ (0.8));
        hh = hh * (t ^ (-0.55));

        %Coeff di scambio in W/m2 K
     
        dqw = hh * aw * (t - twall) / (6 * rpm);  %dqw in J/deg

        xb = mb / m;
        xt = (teta - thant) / dthb;               %Porzione angolare interessata dalla combustione
        
        
        % COMBUSTIONE
        % Combustione motori ad acc per compressione
        
        if id == 1
            
            td = 1;
            alfast = 14.5;
            phiglo = alfast / alfa;
            beta = 1 - 1.2831 * (phiglo ^ 0.7249) / (td ^ (-0.04057));
            c1 = 4.0052 + 0.000000013854 * (rpm * td) ^ 2.1313;
            c2 = 3113.487;
            c3 = 3.6275 / (phiglo ^ 1.2823);
            c4 = 0.7512 * c3 ^ 0.3992;
                if  (0<xt)&&(xt<1)
            % Velocità di comb. premiscelata (dxbp) e diffusiva (dxbd)
                  dxbp = (c1 * c2 * xt ^ (c1 - 1) * (1 - xt ^ c1) ^ (c2 - 1)) / dthb;
                  dxbd = (c3 * c4 * xt ^ (c4 - 1) * exp(-c3 * xt ^ c4)) / dthb;
                  dxb = beta * dxbp + (1 - beta) * dxbd;
                else
                dxb = 0;
                end
        
        
        % Combustione motori ad acc. comandata modellata secondo
        % l'algoritmo del rilascio del calore di Wiebe
        
        elseif (0<xt)&&(xt<1)
         dxb = ((1 - xb) * aa * (e + 1) * xt ^ e) / dthb;
         
        else
         dxb = 0;
        end
        
        if dxb<0                % per sistemare la combustione diesel
            dxb=0;
        end
        
        % Frazioni elementari
        
        dmb = dxb * m;
        dmf = dmb / (alfa + 1);
        dqb = dmf * PCIb;
        
        % Valutazione delle portate
        
                
        [mpin,mphin] = OdLibv2.portex (teta,1,k,pasp,p,hasp,h,roasp,ro,Taspsca,Aaspsca);
        dmin = mpin / 6 / rpm;
        dmhin = mphin / 6 / rpm;
        [mpex,mphex] = OdLibv2.portex (teta,2,k,p,psca,h,hsca,ro,rosca,Taspsca,Aaspsca);
        dmex = mpex / 6 / rpm;
        dmhex = mphex / 6 / rpm;    
        
        % Equazioni di bilancio massa ed energia
        
        dm = dmin - dmex;
        dt = (-p * dv / 1000 - dqw / 1000 + dqb + dmhin - dmhex - u * dm) / m / cv ;
        
        dx = [dmb dt dm];               %Costruisco il vettore che verrà elaborato dalla merson   
   
   
   end
   
   
   function [mp,mph] = portex (teta,iaos,k,pasp,psca,hasp,hsca,roasp,rosca,Taspsca,Aaspsca) %Valuta i flussi entranti e o uscenti dal cilindro
       
       [av] = OdLibv2.avalv (teta,iaos,Taspsca,Aaspsca);
       
       [mp] = OdLibv2.flux0d (k,pasp,psca,roasp,rosca,av);
       
       if mp >= 0 
           mph = mp*hasp;
       else 
           mph = mp*hsca;
       end      
       
   end
   
   
   function [av] = avalv (teta,iaos,Taspsca,Aaspsca) %Calcola l'area di passaggio del fluido
     
       % Selezione l'area di passaggio in linea con l'angolo di manovella
        % analizzato attraverso un'interpolazione lineare della legge
        % d'alzata
        
        av = 0;
        
        for i = 1 : size (Taspsca,1)-1
            
            t1 = Taspsca (i,iaos);
            t2 = Taspsca (i+1,iaos);
            
            avl1 = Aaspsca (i,iaos);
            avl2 = Aaspsca (i+1,iaos);
   
          if (t1<teta)&&(teta<t2)                    %Interpolazione %)t1<teta<t2 
              rap = (teta-t1)/(t2-t1);
              av = avl1 + (avl2-avl1)*rap;
          end
        end
       
       
       
   end
   
   
   function [mp] = flux0d (k,pasp,psca,roasp,rosca,av) %Valuta la portata entrante o uscente 
       
       if pasp == psca                                  %Flusso nullo       
           mp = 0 ;                                     
       elseif pasp > psca 
           [mp] = OdLibv2.flux1 (k,pasp,psca,roasp,av);   %Flusso entrante            
       else 
           [mp] = OdLibv2.flux1 (k,psca,pasp,rosca,av);   %Flusso uscente     
           mp = - mp;
       end       
       
   end
   
   
   function [mp] = flux1 (k,pasp,psca,roinf,av) %Calcola la portata
       
       beta = psca/pasp;
       betacr = (2 / (k + 1)) ^ (k / (k - 1));
       [psi12] = OdLibv2.psi (beta,k);
       [psicr] = OdLibv2.psi (betacr,k);
       psieff = psi12;
       
       if psi12 > psicr
           psieff = psicr;
       end
       
       mp = av*psieff*pasp*(2*roinf/pasp)^(1/2);
             
       
   end
   
   
   function [psi] = psi (beta,k) %Funzione del passaggio di massa in relazione al rapporto tra le pressioni
       
       psi = (k / (k - 1) * (beta ^ (2 / k) - beta ^ ((k + 1) / k)))^(1/2);
   end
   
        
                                                 
 end
end
